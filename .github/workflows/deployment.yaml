name: Build and Deploy
on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Environment
        default: stage.dev
        options:
          - stage.dev
          - stage-1.dev
          - stage-2.dev
          - prod.dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if Workflow execution is from a tag
        run: |
          if [[ "$GITHUB_REF" != refs/tags/* ]]; then
            echo "::error::Workflow execution is not from a tag"
            exit 1
          fi
          echo "Run from Tag: $GITHUB_REF"

      - name: Verify if tag is on main branch
        id: verify_tag
        run: |
          TAG_NAME=$(git tag --contains ${{ github.sha }} | head -n 1)
          if [[ -z "$TAG_NAME" ]]; then
            echo "::error::No tag found for the commit."
            exit 1
          fi
          MAIN_COMMIT=$(git rev-list -n 1 "$TAG_NAME")
          if git branch -r --contains "$MAIN_COMMIT" | grep -q 'origin/main'; then
            echo "Tag is on main branch"
            echo "main_branch=true" >> $GITHUB_ENV
          else
            echo "Tag is not on main branch"
            echo "main_branch=false" >> $GITHUB_ENV
            exit 1
          fi 

      - name: Setup Docker metadata
        uses: docker/metadata-action@v5
        with:
          images: citest/ciapp
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest,enable=${{ env.main_branch == 'true' }}
  
      - name: Deploy stage.dev
        if: github.event.inputs.environment == 'stage.dev'
        run: echo "Deploy stage.dev"
      - name: Deploy stage-1.dev
        if: github.event.inputs.environment == 'stage-1.dev'
        run: echo "Deploy stage-1.dev"
      - name: Deploy stage-2.dev
        if: github.event.inputs.environment == 'stage-2.dev'
        run: echo "Deploy stage-2.dev"
      - name: Deploy prod.dev
        if: github.event.inputs.environment == 'prod.dev'
        run: echo "Deploy prod.dev "
